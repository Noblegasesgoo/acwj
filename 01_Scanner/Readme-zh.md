# ç¬¬ä¸€éƒ¨åˆ†ï¼š è¯æ³•æ‰«æä»‹ç»

æˆ‘ä»¬ä»¥å†™ä¸€ä¸ªç®€å•çš„è¯æ³•æ‰«æå™¨ä¸ºæ‰‹å†™ç¼–è¯‘å™¨æ—…ç¨‹çš„å¼€å§‹ï¼Œå¦‚æˆ‘ä¸Šé¢æ‰€è¯´çš„ï¼Œæ‰«æå™¨çš„å·¥ä½œæ˜¯è¯†åˆ«è¾“å…¥è¯­è¨€å†…å®¹çš„è¯­æ³•å…ƒç´ ä»¥åŠ *tokens*ã€‚

æˆ‘ä»¬å°†ä»ä¸€ä¸ªåªæœ‰äº”ä¸ªè¯æ³•å…ƒç´ çš„è¯­è¨€å¼€å§‹ï¼š

- å››ä¸ªåŸºæœ¬è¿ç®—æ“ä½œï¼š`*`, `/`, `+`,  `-`ã€‚
- ä¸€ä¸ªæˆ–å¤šä¸ªæ•°å­—çš„åè¿›åˆ¶æ•´æ•° `0` .. `9`ã€‚

æˆ‘ä»¬æ‰«æçš„æ¯ä¸ª `token` éƒ½å°†å­˜å‚¨åœ¨è¿™ä¸ªç»“æ„ä¸­ï¼ˆ`defs.h`ï¼‰ï¼š

```c
// Token structure
struct token {
    int token;
    int intvalue;
}
```

`token`å­—æ®µçš„å€¼æ¥å¯ä»¥æ˜¯å¦‚ä¸‹è¿™äº›å€¼ä¹‹ä¸€ï¼ˆ`defs.h`ï¼‰ã€‚

```c
// Tokens
enum {
  T_PLUS, T_MINUS, T_STAR, T_SLASH, T_INTLIT
};
```

å½“ `token` çš„å€¼æ˜¯ `T_INTLIT`ï¼ˆå³æ•´æ•°å­—é¢é‡ï¼‰çš„æ—¶å€™ï¼Œ `intvalue` å­—æ®µå°†æŒæœ‰æˆ‘ä»¬æ‰€æ‰«æåˆ°çš„æ•´æ•°å€¼ã€‚

## `scan.c` ä¸­çš„å‡½æ•°æ–¹æ³•

`scan.c`æ–‡ä»¶ä¸­æ‹¥æœ‰æˆ‘ä»¬è¯æ³•æ‰«æå™¨çš„å‡½æ•°æ–¹æ³•ã€‚æˆ‘ä»¬å°†ä»è¯»å–è¾“å…¥æ–‡ä»¶ä¸€æ¬¡è¯»å–ä¸€ä¸ªå­—ç¬¦ã€‚ä¸è¿‡æœ‰çš„æ—¶å€™æˆ‘ä»¬åœ¨è¾“å…¥æµä¸­è¯»å–å¾—å¤ªé å‰ï¼Œæ­¤æ—¶å°±éœ€è¦â€œæ”¾å›â€ä¸€ä¸ªå­—ç¬¦ã€‚ æˆ‘ä»¬è¿˜æƒ³è¦è¿½è¸ªå½“å‰åœ¨å“ªä¸€è¡Œä»¥ä¾¿æˆ‘ä»¬åœ¨è°ƒè¯•ä¿¡æ¯ä¸­æ‰“å°è¡Œå·ã€‚ä»¥ä¸Šæ‰€æœ‰è¿™äº›åŠŸèƒ½éƒ½ç”± `next()` å‡½æ•°å®Œæˆï¼š

```c
// Get the next character from the input file.
static int next(void) {
    int c;
    
    if (Putback) {			// ä½¿ç”¨è¾“å…¥å­—ç¬¦ Use the character put
		c = Putback; 	    // å¦‚æœåªå‰©ä¸€ä¸ªå°±è¿”å› back if there is one
		Putback = 0;		
		return c;
    }
    
    c = fgetc(Intfile);		// è¯»å–è¾“å…¥æ–‡ä»¶ Read from input file
    if ('\n' == c) { 		
        Line ++;		    // è¡Œæ•°ç»Ÿè®¡å˜é‡è‡ªå¢ Increment line count
        return c;
    }
}
```

å˜é‡ `Putback` ã€`Line` ä¸æˆ‘ä»¬çš„è¾“å…¥æ–‡ä»¶æŒ‡é’ˆä¸€èµ·å®šä¹‰åœ¨äº† `data.h` æ–‡ä»¶ä¸­ï¼š

```c
extern_ int     Line;
extern_ int     Putback;
extern_ FILE    *Infile;
```

æ‰€æœ‰Cæ–‡ä»¶éƒ½ä¼šåŒ…å« `extern` è¢« `extern_` æ›¿æ¢çš„ä»£ç ã€‚ä½†æ˜¯ `main.c` æ–‡ä»¶ä¼šç§»é™¤ `extern_`ï¼›å› æ­¤è¿™äº›å˜é‡å°†ä¼šâ€œå±äºâ€ `main.c`ã€‚

æœ€åï¼Œæˆ‘ä»¬æ€ä¹ˆå°†ä¸€ä¸ªå­—ç¬¦æ”¾å…¥è¾“å…¥æµä¸­å‘¢ï¼Ÿå°±åƒä¸‹é¢è¿™æ ·ï¼š

```c
// Put back an unwanted character å°†ä¸éœ€è¦çš„å­—ç¬¦æ”¾å›è¾“å…¥æµä¸­
static void putback(int c) {
  Putback = c;
}
```

## å¿½ç•¥ç©ºç™½å­—ç¬¦

æˆ‘ä»¬éœ€è¦ä¸€ä¸ªèƒ½è¯»å–å¹¶ä¸”èƒ½è·³è¿‡ç©ºç™½å­—ç¬¦ç›´è‡³è·å–åˆ°ä¸€ä¸ªéç©ºç™½å­—ç¬¦çš„å‡½æ•°æ–¹æ³•ï¼Œå¹¶ä¸”è¿”å›è¿™ä¸ªå­—ç¬¦ã€‚å°±åƒä¸‹é¢è¿™æ ·ï¼š

```c
// Skip past input that we don't need to deal with, è·³è¿‡æˆ‘ä»¬ä¸éœ€è¦å¤„ç†çš„è¾“å…¥å†…å®¹ï¼Œ
// i.e. whitespace, newlines. Return the first å³ç©ºç™½å­—ç¬¦ã€æ¢è¡Œå­—ç¬¦ã€‚è¿”å›ç¬¬ä¸€ä¸ªæˆ‘ä»¬éœ€è¦å¤„ç†çš„å­—ç¬¦ã€‚
// character we do need to deal with.
static int skip(void) {
  int c;

  c = next();
  while (' ' == c || '\t' == c || '\n' == c || '\r' == c || '\f' == c) {
    c = next();
  }
  return (c);
}
```

## æ‰«æTokensï¼š`scan()`

æ‰€ä»¥ç°åœ¨æˆ‘ä»¬å¯ä»¥è¯»å–åˆ°æˆ‘ä»¬éœ€è¦çš„å­—ç¬¦äº†ï¼›å¦‚æœæˆ‘ä»¬è¯»å–äº†ä¸€ä¸ªå¤šä½™çš„å­—ç¬¦ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†å…¶æ”¾å›ã€‚æˆ‘ä»¬ç°åœ¨å°±å¯ä»¥å†™æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªè¯æ³•æ‰«æå™¨äº†ï¼š

```c
// Scan and return the next token found in the input. æ‰«æå¹¶ä¸”è¿”å›è¾“å…¥å†…å®¹ä¸­çš„ä¸‹ä¸€ä¸ªtoken
// Return 1 if token valid, 0 if no tokens left. å¦‚æœtokenæœ‰æ•ˆåˆ™è¿”å›1ï¼Œå¦‚æœæ²¡æœ‰å‰©ä½™tokenåˆ™è¿”å›0
int scan(struct token *t) {
  int c;

  // Skip whitespace è·³è¿‡ç©ºç™½å­—ç¬¦
  c = skip();

  // Determine the token based on æ ¹æ®è¾“å…¥å­—ç¬¦
  // the input character ç¡®å®štoken
  switch (c) {
  case EOF:
    return (0);
  case '+':
    t->token = T_PLUS;
    break;
  case '-':
    t->token = T_MINUS;
    break;
  case '*':
    t->token = T_STAR;
    break;
  case '/':
    t->token = T_SLASH;
    break;
  default:
    // More here soon ä¹‹åä¼šæœ‰æ›´å¤šç±»å‹
  }

  // We found a token æˆ‘ä»¬æ‰¾åˆ°äº†token
  return (1);
}
```

ä»¥ä¸Šå°±æ˜¯å¯¹äºç®€å•å­—ç¬¦`tokens`æ ‡è®°çš„å†…å®¹äº†ï¼šæ¯ä¸€ä¸ªè¢«è¯†åˆ«çš„å­—ç¬¦ï¼Œéƒ½ä¼šå˜æˆä¸€ä¸ª`token`ã€‚ä½ ä¹Ÿè®¸ä¼šè¯´ï¼šä¸ºä»€ä¹ˆä¸ç›´æ¥å°†è¢«è¯†åˆ«çš„å­—ç¬¦æ”¾å…¥`struct token`ä¸­å‘¢ï¼Ÿæˆ‘ä»¬ä¹‹åå°†è¦å¯¹ä¾‹å¦‚ `==` ä»¥åŠ`if` `where`å…³é”®å­—è¿™æ ·çš„å¤šå­—ç¬¦tokensè¿›è¡Œæ ‡è®°æ—¶ä¼šç»™ä½ ç­”æ¡ˆã€‚å› æ­¤ï¼Œæœ‰ä¸€ä¸ªæšä¸¾çš„æ ‡è®°å€¼åˆ—è¡¨ä¼šè®©äº‹æƒ…å˜å¾—æ›´åŠ ç®€ä¾¿ã€‚

## æ•´æ•°å­—é¢å€¼çš„å€¼

äº‹å®ä¸Šï¼Œæˆ‘ä»¬ä¸å¾—ä¸å»é¢å¯¹éœ€è¦å»æ ‡è®°ç±»ä¼¼`3827`å’Œ`87731`è¿™æ ·æ•´æ•°å­—é¢å€¼çš„æƒ…å†µã€‚ä»¥ä¸‹æ˜¯`switch`æ®µä¸­ç¼ºå°‘çš„`default`ä»£ç ï¼š

```c
  default:

    // If it's a digit, scan the å¦‚æœæ˜¯æ•°å­—ï¼Œå°±æ‰«æä»–çš„æ•´æ•°å­—é¢é‡
    // literal integer value in
    if (isdigit(c)) {
      t->intvalue = scanint(c);
      t->token = T_INTLIT;
      break;
    }

    printf("Unrecognised character %c on line %d\n", c, Line);
    exit(1);
```

ä¸€æ—¦æˆ‘ä»¬é‡åˆ°ä¸€ä¸ªåè¿›åˆ¶æ•°å­—å­—ç¬¦ï¼Œæˆ‘ä»¬è°ƒç”¨åä¸º`scanint()`çš„è¾…åŠ©å‡½æ•°ï¼Œå¹¶å°†ç¬¬ä¸€ä¸ªå­—ç¬¦ä½œä¸ºå‚æ•°ä¼ é€’ç»™å®ƒã€‚è¯¥å‡½æ•°ä¼šè¿”å›æ‰«æåˆ°çš„æ•´æ•°å€¼ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œå‡½æ•°å°†ä¼šè¯»å–æ¯ä¸€ä¸ªè¾“å…¥å­—ç¬¦ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯åˆæ³•çš„æ•°å­—å¹¶ä¸”æ„å»ºæœ€ç»ˆæ•°å­—ï¼Œä»¥ä¸‹æ˜¯ä»£ç ï¼š

```c
// Scan and return an integer literal ä»è¾“å…¥æ–‡ä»¶ä¸­æ‰«æå¹¶è¿”å›æ•´æ•°å­—é¢é‡
// value from the input file. Store å°†å€¼ä½œä¸ºå­—ç¬¦ä¸²å­˜å‚¨åœ¨Textä¸­
// the value as a string in Text.
static int scanint(int c) {
  int k, val = 0;

  // Convert each character into an int value è½¬æ¢æ¯ä¸€ä¸ªå­—ç¬¦ä¸ºintå€¼
  while ((k = chrpos("0123456789", c)) >= 0) {
    val = val * 10 + k;
    c = next();
  }

  // We hit a non-integer character, put it back. å½“æˆ‘ä»¬é‡åˆ°ä¸€ä¸ªéæ•´æ•°å­—ç¬¦æ˜¯ï¼Œå°†å…¶æ”¾å›
  putback(c);
  return val;
}
```

æˆ‘ä»¬ä»¥ä¸º0çš„`val`å€¼å¼€å§‹ï¼Œæ¯æ¬¡æˆ‘ä»`0ï¼Œ9`çš„èŒƒå›´ä¸­è·å–ä¸€ä¸ªå­—ç¬¦ä¸²æˆ‘ä»¬å°±ç”¨ `chrpos()`å‡½æ•°æ¥å°†å…¶è½¬æ¢ä¸º`int`å€¼ã€‚æˆ‘ä»¬å°†`val`å˜å¤§åå€ï¼Œå¹¶ä¸”å°†è¿™ä¸ªæ–°æ•°å­—æ·»åŠ åˆ°å…¶ä¸­ã€‚

ä¸¾ä¸ªğŸŒ°ï¼Œå¦‚æœæˆ‘ä»¬æœ‰å­—ç¬¦é›†  `3`, `2`, `8`, æˆ‘ä»¬è¦å°†å…¶è½¬æ¢æˆ`328`æˆ‘ä»¬è¿™ä¹ˆåšï¼š

- `val = 0 * 10 + 3`ï¼Œå³3
- `val = 3 * 10 + 2`ï¼Œå³32
- `val = 32 * 10 + 8`ï¼Œå³328

åœ¨æœ€åï¼Œä½ æœ‰æ²¡æœ‰æ³¨æ„åˆ°ä¸€ä¸ªåä¸º `putback(c)` çš„å‡½æ•°ï¼ˆæ‚¨æ³¨æ„åˆ°äº†å¯¹`putback(c)`çš„è°ƒç”¨å—ï¼Ÿï¼‰ï¼Ÿåœ¨è¿™é‡Œæˆ‘ä»¬æ‰¾åˆ°ä¸€ä¸ªä¸å±äºåè¿›åˆ¶æ•°å­—çš„å­—ç¬¦ã€‚æˆ‘ä»¬ä¸èƒ½ç®€å•çš„å°†ä»–ä¸¢å¼ƒï¼Œä½†å¹¸è¿çš„æ˜¯æˆ‘ä»¬å¯ä»¥å°†å…¶æ”¾å›åˆ°è¾“å‡ºæµä¸­ä»¥ä¾¿ä¹‹åä½¿ç”¨ã€‚

ä½ ä¹Ÿè®¸ä¼šè¯¢é—®è¿™ä¸ªç‚¹ï¼šä¸ºä»€ä¹ˆä¸ç”¨ ASCII ç çš„ '0' åˆ°`c`ç®€å•çš„å‡å»è¯¥å­—ç¬¦ä»è€Œè·å¾—è¯¥å­—ç¬¦çš„æ•´å½¢å€¼å‘¢ï¼Ÿç¨åæˆ‘ä»¬ä¼šä½¿ç”¨`chrpos("0123456789abcdef")` å‡½æ•°å°†åå…­è¿›åˆ¶æ•°å­—è¿›è¡Œè½¬æ¢ä¾¿æ˜¯ç­”æ¡ˆã€‚

ä»¥ä¸‹æ˜¯ `chrpos()` çš„ä»£ç ï¼š

```c
// Return the position of character c è¿”å›å­—ç¬¦cä½äºå­—ç¬¦ä¸²sä¸­çš„ä½ç½®ï¼Œæ‰¾ä¸åˆ°çš„è¯å°±è¿”å›-1
// in string s, or -1 if c not found
static int chrpos(char *s, int c) {
  char *p;

  p = strchr(s, c);
  return (p ? p - s : -1);
}
```

è¿™äº›æš‚æ—¶å°±æ˜¯ç›®å‰è¯æ³•åˆ†ææ‰«æå™¨ä¸­çš„ä»£ç å†…å®¹äº†ã€‚

## è®©è¯æ³•åˆ†ææ‰«æå™¨å¼€å§‹å·¥ä½œ

ä¸‹é¢`main.c` çš„ä»£ç å°†ä¸Šè¿°å†…å®¹ä¸­çš„è¯æ³•åˆ†ææ‰«æå™¨æŠ•å…¥ä½¿ç”¨ã€‚è¯¥å‡½æ•°æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶åæ‰«æå…¶ä¸­çš„tokensï¼š

```c
void main(int argc, char *argv[]) {
  ...
  init();
  ...
  Infile = fopen(argv[1], "r");
  ...
  scanfile();
  exit(0);
}
```

æ¥ç€ `scanfile()` åœ¨å­˜åœ¨æ–°æ ‡è®°æ—¶å¾ªç¯ï¼Œå¹¶æ‰“å°å‡ºæ ‡è®°çš„è¯¦ç»†ä¿¡æ¯ï¼š

And `scanfile()` loops while there is a new token and prints out the
details of the token:

```c
// List of printable tokens å¯æ‰“å°çš„æ ‡è®°åˆ—è¡¨
char *tokstr[] = { "+", "-", "*", "/", "intlit" };

// Loop scanning in all the tokens in the input file. å¾ªç¯æ‰«æè¾“å…¥æ–‡ä»¶çš„æ‰€æœ‰token
// Print out details of each token found. æ‰“å°æ‰€æœ‰æ‰¾åˆ°çš„tokençš„è¯¦ç»†ä¿¡æ¯
static void scanfile() {
  struct token T;

  while (scan(&T)) {
    printf("Token %s", tokstr[T.token]);
    if (T.token == T_INTLIT)
      printf(", value %d", T.intvalue);
    printf("\n");
  }
}
```

## ä¸€äº›ç¤ºä¾‹è¾“å…¥æ–‡ä»¶

æˆ‘æä¾›äº†ä¸€äº›ç¤ºä¾‹è¾“å…¥æ–‡ä»¶ï¼Œä½ å¯ä»¥çœ‹çœ‹é€šè¿‡æ‰«æå™¨èƒ½ä»ä»–ä»¬ä¸­æ‰«æåˆ°äº›ä»€ä¹ˆtokensä»¥åŠçœ‹çœ‹å“ªäº›æ–‡ä»¶æ˜¯è¢«æ‰«æå™¨æ‹’ç»äº†çš„ã€‚

```
$ make
cc -o scanner -g main.c scan.c

$ cat input01
2 + 3 * 5 - 8 / 3

$ ./scanner input01
Token intlit, value 2
Token +
Token intlit, value 3
Token *
Token intlit, value 5
Token -
Token intlit, value 8
Token /
Token intlit, value 3

$ cat input04
23 +
18 -
45.6 * 2
/ 18

$ ./scanner input04
Token intlit, value 23
Token +
Token intlit, value 18
Token -
Token intlit, value 45
Unrecognised character . on line 3
```

## æ€»ç»“åŠä¸‹ä¸€æ­¥

æˆ‘ä»¬å¼€å§‹åšäº†ä¸€ä¸ªå¯ä»¥åšæ ‡è®°å››ä¸ªæ•°å­¦è¿ç®—ç¬¦ä»¥åŠæ•°å­—å­—é¢å€¼çš„å°è€Œç®€æ˜“çš„è¯æ³•åˆ†ææ‰«æå™¨ã€‚æˆ‘ä»¬æ³¨æ„åˆ°å¦‚æœè¯»å–è¾“å…¥æ—¶è¯»å–å¾—å¤ªè¿œï¼Œå°±éœ€è¦è·³è¿‡ç©ºç™½å­—ç¬¦å¹¶å°†å­—ç¬¦æ”¾å›ã€‚

å•ä¸ªå­—ç¬¦çš„tokensæ‰«æèµ·æ¥æ˜¯å¾ˆç®€å•çš„ï¼Œä½†æ˜¯å¦‚æœæ˜¯å¤šä¸ªå­—ç¬¦tokensçš„æ‰«æå°±ä¼šå˜å¾—æ¯”è¾ƒéº»çƒ¦ã€‚ä¸è¿‡åœ¨æœ€åï¼Œ`scan()` å‡½æ•°ä¼šå°†è¾“å…¥æ–‡ä»¶ä¸­çš„ä¸‹ä¸€ä¸ªæ ‡è®°è¿”å›åˆ°ä¸€ä¸ªåä¸º `struct token` çš„å˜é‡ä¸­ï¼š

```c
struct token {
  int token;
  int intvalue;
};
```

åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¼šæ„å»ºä¸€ä¸ªé€’å½’æ·±å…¥çš„è§£æå™¨æ¥è§£ææˆ‘ä»¬è¾“å…¥æ–‡ä»¶çš„è¯­æ³•ï¼Œè®¡ç®—å¹¶æ‰“å°å‡ºæ¯ä¸ªæ–‡ä»¶çš„æœ€ç»ˆå€¼[Next step](../02_Parser/Readme.md)ã€‚
